<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard â€“ TutorsLink</title>
  <meta name="description" content="Staff-only dashboard for reviewing and approving tutor applications on TutorsLink." />
  <link rel="stylesheet" href="assets/css/tutorslink.css" />
</head>
<body>

  <!-- ====== Navigation ====== -->
  <nav class="tl-nav" role="navigation" aria-label="Main navigation">
    <a href="index.html" class="tl-nav__logo" aria-label="TutorsLink home">
      <div class="tl-nav__logo-icon" aria-hidden="true">ðŸŽ“</div>
      TutorsLink
    </a>
    <ul class="tl-nav__links" role="list">
      <li><a href="index.html">Home</a></li>
      <li><a href="find-a-tutor.html">Find a Tutor</a></li>
      <li><a href="tutor-application.html">Apply as Tutor</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="contact.html">Contact</a></li>
      <li><a href="policies.html">Policies</a></li>
      <li><a href="guides.html">Guides &amp; Help</a></li>
      <li data-role="staff" style="display:none"><a href="admin-dashboard.html" class="active">Admin Dashboard</a></li>
    </ul>
    <div class="tl-nav__cta">
      <a href="find-a-tutor.html" class="btn btn-outline">Find a Tutor</a>
      <a href="tutor-application.html" class="btn btn-primary">Apply as Tutor</a>
    </div>
    <button class="tl-nav__hamburger" aria-label="Toggle menu" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>
  </nav>

  <!-- ====== Page Header ====== -->
  <header class="tl-page-header">
    <div class="tl-section__tag">Staff Only</div>
    <h1>Admin Dashboard</h1>
    <p>Review and approve pending tutor applications.</p>
  </header>

  <!-- ====== Access Denied (guests) ====== -->
  <section class="tl-section" data-role="guest" style="display:none;text-align:center;" aria-label="Access denied">
    <div style="max-width:500px;margin:0 auto;padding:3rem 1rem;">
      <div style="font-size:3rem;margin-bottom:1rem;" aria-hidden="true">ðŸ”’</div>
      <h2 class="tl-section__title" style="margin-bottom:1rem;">Staff Access Required</h2>
      <p style="color:var(--color-text-muted);margin-bottom:2rem;">
        Please sign in with a staff account to access the Admin Dashboard.
      </p>
      <button class="btn btn-primary" onclick="window.TLFunctions && window.TLFunctions.openAuthModal()">
        Sign In
      </button>
    </div>
  </section>

  <!-- ====== Access Denied (students / tutors) ====== -->
  <section class="tl-section" data-role="student,tutor" style="display:none;text-align:center;" aria-label="Unauthorised">
    <div style="max-width:500px;margin:0 auto;padding:3rem 1rem;">
      <div style="font-size:3rem;margin-bottom:1rem;" aria-hidden="true">â›”</div>
      <h2 class="tl-section__title" style="margin-bottom:1rem;">Unauthorised</h2>
      <p style="color:var(--color-text-muted);margin-bottom:2rem;">
        This page is restricted to TutorsLink staff. If you believe this is a mistake, please
        <a href="contact.html" style="color:var(--color-yellow)">contact us</a>.
      </p>
      <a href="index.html" class="btn btn-outline">Back to Home</a>
    </div>
  </section>

  <!-- ====== Staff Dashboard ====== -->
  <section class="tl-section tl-section--alt" data-role="staff" style="display:none;" aria-labelledby="dashboard-title">
    <div class="tl-section__header">
      <div class="tl-section__tag">Pending Review</div>
      <h2 class="tl-section__title" id="dashboard-title">Tutor Applications</h2>
      <p class="tl-section__desc">Approve applications to grant the tutor role to applicants.</p>
    </div>

    <!-- Status / loading message -->
    <div id="dashboard-status" style="text-align:center;padding:2rem;color:var(--color-text-muted);" role="status" aria-live="polite">
      Loading applicationsâ€¦
    </div>

    <!-- Applications table -->
    <div id="applications-container" style="display:none;overflow-x:auto;">
      <table id="applications-table" style="width:100%;border-collapse:collapse;font-size:0.9rem;" aria-label="Pending tutor applications">
        <thead>
          <tr style="border-bottom:2px solid var(--color-border);">
            <th style="padding:0.75rem 1rem;text-align:left;color:var(--color-yellow);font-weight:700;">Name</th>
            <th style="padding:0.75rem 1rem;text-align:left;color:var(--color-yellow);font-weight:700;">Email</th>
            <th style="padding:0.75rem 1rem;text-align:left;color:var(--color-yellow);font-weight:700;">Subject</th>
            <th style="padding:0.75rem 1rem;text-align:left;color:var(--color-yellow);font-weight:700;">Country</th>
            <th style="padding:0.75rem 1rem;text-align:left;color:var(--color-yellow);font-weight:700;">Submitted</th>
            <th style="padding:0.75rem 1rem;text-align:center;color:var(--color-yellow);font-weight:700;">Action</th>
          </tr>
        </thead>
        <tbody id="applications-tbody">
        </tbody>
      </table>
    </div>

    <!-- Empty state -->
    <div id="no-applications" style="display:none;text-align:center;padding:3rem 1rem;">
      <div style="font-size:2.5rem;margin-bottom:1rem;" aria-hidden="true">âœ…</div>
      <p style="font-size:1.1rem;font-weight:600;color:var(--color-white);">No pending applications</p>
      <p style="color:var(--color-text-muted);">All tutor applications have been reviewed.</p>
    </div>
  </section>

  <!-- ====== Staff Ads Management ====== -->
  <section class="tl-section" data-role="staff" style="display:none;" aria-labelledby="ads-title">
    <div class="tl-section__header">
      <div class="tl-section__tag">Ads &amp; Announcements</div>
      <h2 class="tl-section__title" id="ads-title">Manage Announcements</h2>
      <p class="tl-section__desc">Create, edit, and archive public-facing announcements.</p>
    </div>

    <div style="max-width:1100px;margin:0 auto;">
      <!-- Toolbar -->
      <div style="display:flex;justify-content:flex-end;margin-bottom:1.5rem;">
        <button class="btn btn-primary" id="ads-create-btn" style="gap:0.5rem;">
          ï¼‹ Create Announcement
        </button>
      </div>

      <!-- Status / loading -->
      <div id="ads-status" style="text-align:center;padding:2rem;color:var(--color-text-muted);" role="status" aria-live="polite">
        Loading announcementsâ€¦
      </div>

      <!-- Ads table -->
      <div id="ads-container" style="display:none;overflow-x:auto;">
        <table id="ads-table" style="width:100%;border-collapse:collapse;font-size:0.9rem;" aria-label="Announcements">
          <thead>
            <tr style="border-bottom:2px solid var(--color-border);">
              <th style="padding:0.75rem 1rem;text-align:left;color:var(--color-yellow);font-weight:700;">Title</th>
              <th style="padding:0.75rem 1rem;text-align:left;color:var(--color-yellow);font-weight:700;">Source</th>
              <th style="padding:0.75rem 1rem;text-align:left;color:var(--color-yellow);font-weight:700;">Status</th>
              <th style="padding:0.75rem 1rem;text-align:left;color:var(--color-yellow);font-weight:700;">Created</th>
              <th style="padding:0.75rem 1rem;text-align:center;color:var(--color-yellow);font-weight:700;">Actions</th>
            </tr>
          </thead>
          <tbody id="ads-tbody"></tbody>
        </table>
      </div>

      <!-- Empty state -->
      <div id="ads-empty" style="display:none;text-align:center;padding:3rem 1rem;">
        <div style="font-size:2.5rem;margin-bottom:1rem;" aria-hidden="true">ðŸ“¢</div>
        <p style="font-size:1.1rem;font-weight:600;color:var(--color-white);">No announcements yet</p>
        <p style="color:var(--color-text-muted);">Create your first announcement above.</p>
      </div>
    </div>
  </section>

  <!-- ====== Ad Create / Edit Modal ====== -->
  <div class="tl-modal-overlay" id="ad-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="ad-modal-title">
    <div class="tl-modal" style="max-width:540px;">
      <button class="tl-modal__close" id="ad-modal-close" aria-label="Close">&#10005;</button>
      <h2 class="tl-section__title" id="ad-modal-title" style="margin-bottom:1.5rem;">New Announcement</h2>
      <form id="ad-modal-form" novalidate>
        <div class="tl-form-group" style="margin-bottom:1rem;">
          <label for="ad-title-input">Title <span class="required">*</span></label>
          <input type="text" id="ad-title-input" name="title" placeholder="Short headlineâ€¦" required maxlength="120" />
        </div>
        <div class="tl-form-group" style="margin-bottom:1.5rem;">
          <label for="ad-body-input">Body <span class="required">*</span></label>
          <textarea id="ad-body-input" name="body" rows="5" placeholder="Announcement detailsâ€¦" required maxlength="2000" style="resize:vertical;"></textarea>
        </div>
        <div id="ad-modal-error" style="color:var(--color-pink);font-size:0.85rem;margin-bottom:0.75rem;display:none;"></div>
        <div style="display:flex;gap:0.75rem;justify-content:flex-end;">
          <button type="button" class="btn btn-outline" id="ad-modal-cancel">Cancel</button>
          <button type="submit" class="btn btn-primary" id="ad-modal-submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ====== Footer ====== -->
  <footer class="tl-footer" role="contentinfo">
    <div class="tl-footer__grid">
      <div class="tl-footer__brand">
        <a href="index.html" class="tl-nav__logo" style="margin-bottom:0.5rem">
          <div class="tl-nav__logo-icon" aria-hidden="true">ðŸŽ“</div>
          TutorsLink
        </a>
        <p>Connecting students and tutors all over the world. Learn anything, from anyone, anywhere.</p>
      </div>
      <div class="tl-footer__col">
        <h4>Platform</h4>
        <ul>
          <li><a href="find-a-tutor.html">Find a Tutor</a></li>
          <li><a href="tutor-application.html">Apply as Tutor</a></li>
          <li><a href="index.html#features">Features</a></li>
          <li><a href="index.html#why-us">Why Us</a></li>
        </ul>
      </div>
      <div class="tl-footer__col">
        <h4>Company</h4>
        <ul>
          <li><a href="about.html">About</a></li>
          <li><a href="contact.html">Contact</a></li>
          <li><a href="policies.html">Policies</a></li>
          <li><a href="guides.html">Guides &amp; Help</a></li>
        </ul>
      </div>
      <div class="tl-footer__col">
        <h4>Follow Us</h4>
        <ul>
          <li><a href="https://www.instagram.com/tutors.link" target="_blank" rel="noopener">Instagram</a></li>
          <li><a href="https://www.tiktok.com/@tutors_link" target="_blank" rel="noopener">TikTok</a></li>
          <li><a href="https://discord.com/invite/QADbayjzMp" target="_blank" rel="noopener">Discord</a></li>
          <li><a href="https://www.facebook.com/share/19xpPSGgFa/" target="_blank" rel="noopener">Facebook</a></li>
        </ul>
      </div>
    </div>
    <div class="tl-footer__bottom">
      <p>&copy; 2025 TutorsLink. All rights reserved.</p>
    </div>
  </footer>

  <!-- ====== Toast ====== -->
  <div class="tl-toast" id="tl-toast" role="alert" aria-live="polite"></div>

  <script src="assets/js/firebase-app.js"></script>
  <script>
  (function () {
    'use strict';

    /* ---- Utility ---- */
    function escHtml(str) {
      return String(str)
        .replace(/&/g,  '&amp;')
        .replace(/</g,  '&lt;')
        .replace(/>/g,  '&gt;')
        .replace(/"/g,  '&quot;')
        .replace(/'/g,  '&#39;');
    }

    function formatDate(value) {
      if (!value) return 'N/A';
      /* Firestore Timestamp has .toDate(); plain Date or ISO string also accepted */
      var d = (value && typeof value.toDate === 'function') ? value.toDate() : new Date(value);
      if (isNaN(d.getTime())) return 'N/A';
      return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }

    /* ---- Mobile nav ---- */
    function initMobileNav() {
      var hamburger = document.querySelector('.tl-nav__hamburger');
      var nav       = document.querySelector('.tl-nav');
      if (!hamburger || !nav) return;

      hamburger.addEventListener('click', function () {
        var isOpen = nav.classList.toggle('mobile-open');
        hamburger.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      });

      document.addEventListener('click', function (e) {
        if (!nav.contains(e.target)) {
          nav.classList.remove('mobile-open');
          hamburger.setAttribute('aria-expanded', 'false');
        }
      });
    }

    /* ---- Render applications ---- */
    function renderApplications(apps) {
      var status    = document.getElementById('dashboard-status');
      var container = document.getElementById('applications-container');
      var tbody     = document.getElementById('applications-tbody');
      var noApps    = document.getElementById('no-applications');

      if (status)    status.style.display    = 'none';
      if (container) container.style.display = 'none';
      if (noApps)    noApps.style.display    = 'none';

      if (!apps || apps.length === 0) {
        if (noApps) noApps.style.display = 'block';
        return;
      }

      if (!tbody || !container) return;

      tbody.innerHTML = apps.map(function (app) {
        var name = escHtml(((app.firstName || '') + ' ' + (app.lastName || '')).trim()) || 'N/A';
        return (
          '<tr style="border-bottom:1px solid var(--color-border);">' +
            '<td style="padding:0.75rem 1rem;">' + name + '</td>' +
            '<td style="padding:0.75rem 1rem;">' + escHtml(app.email || 'N/A') + '</td>' +
            '<td style="padding:0.75rem 1rem;">' + escHtml(app.primarySubject || 'N/A') + '</td>' +
            '<td style="padding:0.75rem 1rem;">' + escHtml(app.country || 'N/A') + '</td>' +
            '<td style="padding:0.75rem 1rem;white-space:nowrap;">' + formatDate(app.submittedAt) + '</td>' +
            '<td style="padding:0.75rem 1rem;text-align:center;">' +
              '<button class="btn btn-primary js-approve-btn" ' +
                'data-uid="' + escHtml(app.uid || '') + '" ' +
                'data-app-id="' + escHtml(app.id) + '" ' +
                'style="font-size:0.8rem;padding:0.4rem 0.9rem;"' +
                (app.uid ? '' : ' disabled title="No UID â€” applicant was not signed in"') +
              '>Approve</button>' +
            '</td>' +
          '</tr>'
        );
      }).join('');

      container.style.display = 'block';

      /* Wire approve buttons */
      tbody.querySelectorAll('.js-approve-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var uid   = btn.getAttribute('data-uid');
          var appId = btn.getAttribute('data-app-id');
          if (!uid) { return; }
          handleApprove(btn, uid, appId);
        });
      });
    }

    /* ---- Approve handler ---- */
    function handleApprove(btn, uid, applicationId) {
      btn.disabled = true;
      btn.textContent = 'Approvingâ€¦';

      window.TLFunctions.approveTutorApplication(uid, applicationId)
        .then(function () {
          btn.textContent = 'âœ… Approved';
          btn.style.background = 'var(--color-text-muted)';
          window.TLFunctions.showToast('Tutor approved successfully!', 'success');
          /* Remove the row after a short delay */
          setTimeout(function () {
            var row = btn.closest('tr');
            if (row) row.remove();
            /* If no rows left, show empty state */
            var tbody = document.getElementById('applications-tbody');
            if (tbody && tbody.rows.length === 0) {
              var container = document.getElementById('applications-container');
              var noApps    = document.getElementById('no-applications');
              if (container) container.style.display = 'none';
              if (noApps)    noApps.style.display    = 'block';
            }
          }, 1200);
        })
        .catch(function (err) {
          btn.disabled = false;
          btn.textContent = 'Approve';
          var msg = (err && err.message) ? err.message : 'Approval failed. Please try again.';
          window.TLFunctions.showToast('Error: ' + msg, 'error');
        });
    }

    /* ---- Load applications ---- */
    function loadApplications() {
      var status = document.getElementById('dashboard-status');
      if (status) {
        status.style.display = 'block';
        status.textContent   = 'Loading applicationsâ€¦';
      }

      window.TLFunctions.listPendingApplications()
        .then(function (apps) {
          renderApplications(apps);
        })
        .catch(function (err) {
          if (status) {
            status.style.display = 'block';
            status.textContent   = 'Failed to load applications. Please refresh to try again.';
          }
          console.error('[AdminDashboard] Failed to load applications:', err);
        });
    }

    /* ---------------------------------------------------------------- */
    /*  Ads Management                                                  */
    /* ---------------------------------------------------------------- */

    /* Tracks which ad is being edited (null = creating a new one) */
    var editingAdId = null;

    function openAdModal(ad) {
      editingAdId = ad ? ad.id : null;
      var title   = document.getElementById('ad-modal-title');
      var titleIn = document.getElementById('ad-title-input');
      var bodyIn  = document.getElementById('ad-body-input');
      var errEl   = document.getElementById('ad-modal-error');
      var overlay = document.getElementById('ad-modal-overlay');
      var submit  = document.getElementById('ad-modal-submit');

      if (title)   title.textContent  = ad ? 'Edit Announcement' : 'New Announcement';
      if (submit)  submit.textContent = ad ? 'Save Changes' : 'Save';
      if (titleIn) titleIn.value      = ad ? (ad.title || '') : '';
      if (bodyIn)  bodyIn.value       = ad ? (ad.body  || '') : '';
      if (errEl)   errEl.style.display = 'none';

      if (overlay) {
        overlay.classList.add('open');
      }
      document.body.style.overflow = 'hidden';
      if (titleIn) titleIn.focus();
    }

    function closeAdModal() {
      var overlay = document.getElementById('ad-modal-overlay');
      if (overlay) {
        overlay.classList.remove('open');
      }
      document.body.style.overflow = '';
      editingAdId = null;
    }

    function renderAdsTable(ads) {
      var status    = document.getElementById('ads-status');
      var container = document.getElementById('ads-container');
      var tbody     = document.getElementById('ads-tbody');
      var empty     = document.getElementById('ads-empty');

      if (status)    status.style.display    = 'none';
      if (container) container.style.display = 'none';
      if (empty)     empty.style.display     = 'none';

      if (!ads || ads.length === 0) {
        if (empty) empty.style.display = 'block';
        return;
      }
      if (!tbody || !container) return;

      tbody.innerHTML = ads.map(function (ad) {
        var statusColor = ad.status === 'active' ? 'var(--color-yellow)' : 'var(--color-text-muted)';
        return (
          '<tr style="border-bottom:1px solid var(--color-border);">' +
            '<td style="padding:0.75rem 1rem;max-width:260px;word-break:break-word;">' + escHtml(ad.title || '') + '</td>' +
            '<td style="padding:0.75rem 1rem;text-transform:capitalize;">' + escHtml(ad.source || 'website') + '</td>' +
            '<td style="padding:0.75rem 1rem;color:' + statusColor + ';text-transform:capitalize;">' + escHtml(ad.status || 'active') + '</td>' +
            '<td style="padding:0.75rem 1rem;white-space:nowrap;">' + formatDate(ad.createdAt) + '</td>' +
            '<td style="padding:0.75rem 1rem;text-align:center;white-space:nowrap;">' +
              '<button class="btn btn-outline js-ad-edit-btn" data-ad-id="' + escHtml(ad.id) + '" ' +
                'style="font-size:0.8rem;padding:0.35rem 0.8rem;margin-right:0.4rem;" ' +
                (ad.source === 'discord' ? 'title="Discord-synced ads can only be edited on Discord"' : '') +
                (ad.source === 'discord' ? 'disabled' : '') +
              '>Edit</button>' +
              (ad.status === 'active'
                ? '<button class="btn btn-secondary js-ad-archive-btn" data-ad-id="' + escHtml(ad.id) + '" ' +
                    'style="font-size:0.8rem;padding:0.35rem 0.8rem;">Archive</button>'
                : '<button class="btn btn-outline js-ad-restore-btn" data-ad-id="' + escHtml(ad.id) + '" ' +
                    'style="font-size:0.8rem;padding:0.35rem 0.8rem;">Restore</button>') +
            '</td>' +
          '</tr>'
        );
      }).join('');

      container.style.display = 'block';

      /* Wire edit buttons */
      tbody.querySelectorAll('.js-ad-edit-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var id = btn.getAttribute('data-ad-id');
          var ad = ads.find(function (a) { return a.id === id; });
          if (ad) openAdModal(ad);
        });
      });

      /* Wire archive buttons */
      tbody.querySelectorAll('.js-ad-archive-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var id = btn.getAttribute('data-ad-id');
          btn.disabled = true;
          btn.textContent = 'â€¦';
          window.TLFunctions.archiveAd(id)
            .then(function () {
              window.TLFunctions.showToast('Announcement archived.', 'success');
              loadAds();
            })
            .catch(function (err) {
              btn.disabled = false;
              btn.textContent = 'Archive';
              window.TLFunctions.showToast('Error: ' + ((err && err.message) || 'Archive failed.'), 'error');
            });
        });
      });

      /* Wire restore buttons */
      tbody.querySelectorAll('.js-ad-restore-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var id = btn.getAttribute('data-ad-id');
          btn.disabled = true;
          btn.textContent = 'â€¦';
          window.TLFunctions.updateAd(id, { status: 'active' })
            .then(function () {
              window.TLFunctions.showToast('Announcement restored.', 'success');
              loadAds();
            })
            .catch(function (err) {
              btn.disabled = false;
              btn.textContent = 'Restore';
              window.TLFunctions.showToast('Error: ' + ((err && err.message) || 'Restore failed.'), 'error');
            });
        });
      });
    }

    function loadAds() {
      var status = document.getElementById('ads-status');
      if (status) {
        status.style.display = 'block';
        status.textContent   = 'Loading announcementsâ€¦';
      }
      var container = document.getElementById('ads-container');
      var empty     = document.getElementById('ads-empty');
      if (container) container.style.display = 'none';
      if (empty)     empty.style.display     = 'none';

      window.TLFunctions.listAds(true)
        .then(function (ads) { renderAdsTable(ads); })
        .catch(function (err) {
          if (status) {
            status.style.display = 'block';
            status.textContent   = 'Failed to load announcements. Please refresh.';
          }
          console.error('[AdminDashboard] Failed to load ads:', err);
        });
    }

    function initAdsManagement() {
      var createBtn = document.getElementById('ads-create-btn');
      if (createBtn) {
        createBtn.addEventListener('click', function () { openAdModal(null); });
      }

      var closeBtn   = document.getElementById('ad-modal-close');
      var cancelBtn  = document.getElementById('ad-modal-cancel');
      var overlay    = document.getElementById('ad-modal-overlay');
      var form       = document.getElementById('ad-modal-form');

      if (closeBtn)  closeBtn.addEventListener('click',  closeAdModal);
      if (cancelBtn) cancelBtn.addEventListener('click', closeAdModal);

      if (overlay) {
        overlay.addEventListener('click', function (e) {
          if (e.target === overlay) closeAdModal();
        });
      }

      if (form) {
        form.addEventListener('submit', function (e) {
          e.preventDefault();
          var titleEl  = document.getElementById('ad-title-input');
          var bodyEl   = document.getElementById('ad-body-input');
          var errEl    = document.getElementById('ad-modal-error');
          var submit   = document.getElementById('ad-modal-submit');

          if (!titleEl || !bodyEl) { return; }
          var title = titleEl.value.trim();
          var body  = bodyEl.value.trim();

          if (errEl) errEl.style.display = 'none';
          if (!title || !body) {
            if (errEl) { errEl.textContent = 'Title and body are required.'; errEl.style.display = 'block'; }
            return;
          }

          if (submit) { submit.disabled = true; submit.textContent = 'Savingâ€¦'; }

          var promise = editingAdId
            ? window.TLFunctions.updateAd(editingAdId, { title: title, body: body })
            : window.TLFunctions.createAd({ title: title, body: body });

          promise
            .then(function () {
              closeAdModal();
              window.TLFunctions.showToast(
                editingAdId ? 'Announcement updated!' : 'Announcement created!', 'success'
              );
              loadAds();
            })
            .catch(function (err) {
              if (submit) { submit.disabled = false; submit.textContent = 'Save'; }
              var msg = (err && err.message) ? err.message : 'Save failed. Please try again.';
              if (errEl) { errEl.textContent = msg; errEl.style.display = 'block'; }
            });
        });
      }
    }

    /* ---- Init ---- */
    document.addEventListener('DOMContentLoaded', function () {
      initMobileNav();
      initAdsManagement();

      /* Wait for Firebase auth to resolve, then react to role */
      window.TLFunctions.onRoleChange(function (role) {
        if (role === 'staff') {
          loadApplications();
          loadAds();
        }
      });
    });

  }());
  </script>

</body>
</html>
